defaults:
  - override hydra/job_logging: none
  - override hydra/hydra_logging: none

mission: kepler
raw_tables_dir: data/raw/tables
raw_time_series_dir: data/raw/time_series
interim_tables_dir: data/interim/tables
interim_time_series_dir: data/interim/time_series

download:
  verbose: true
  download_tables: true
  download_time_series: true
  script_description: |
    This script downloads star or system brightness time series and scalar stellar and TCE data and
    saves them in unaltered, raw form at user-specified locations.

    In order to download time series, a file with target identifiers is required, e.g. a file with
    TCE data.

    The script has a mechanism for retrying the download in case of an error.

    The metadata of the time series downloaded once is saved in the file and time series are not
    downloaded again the next time the script is run (unless the metadata file has been deleted).

    Note that the size of the downloaded data is significant (hundreds of GB).
  tce_file_path: ${raw_tables_dir}/q1_q17_dr25_tce.csv
  tce_file_target_id_column: kepid
  downloader:
    _target_: gaia.downloaders.KeplerDownloader
    saver:
      _target_: gaia.io.FileSaver
      tables_dir: ${raw_tables_dir}
      time_series_dir: ${raw_time_series_dir}
    cadence: llc
    mast_base_url: https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:Kepler/url/missions/kepler/lightcurves
    nasa_base_url: https://exoplanetarchive.ipac.caltech.edu/cgi-bin/nstedAPI/nph-nstedAPI
    num_async_requests: 25
  tables_requests:
    - - ${download.downloader.nasa_base_url}?table=q1_q17_dr25_tce&columns=kepid,tce_plnt_num,tce_rogue_flag,tce_period,tce_time0bk,tce_time0,tce_duration,tce_depth,tce_prad,tcet_period,boot_fap,tce_cap_stat,tce_hap_stat,tce_rb_tcount0&format=csv
      - q1_q17_dr25_tce.csv
    - - ${download.downloader.nasa_base_url}?table=q1_q17_dr25_koi&columns=kepid,kepoi_name,kepler_name,koi_disposition,koi_pdisposition,koi_tce_plnt_num&format=csv
      - q1_q17_dr25_koi.csv
    - - ${download.downloader.nasa_base_url}?table=q1_q17_dr25_stellar&columns=kepid,teff,radius,mass,dens,logg,feh&format=csv
      - q1_q17_dr25_stellar.csv

preprocessing:
  tce_merge:
    script_description: Merge TCE data with other scalar data (e.g. KOI and/or CFP tables) to obtain TCE labels and Kepler names.
    select_sql: SELECT tce.* REPLACE (tce_duration / 24 AS tce_duration), koi.* EXCLUDE(kepid), koi.kepid AS kepid_koi # Mark TCEs whose are not present in KOI and convert 'duration' from hours to days
    join_sql: "'${raw_tables_dir}/${download.tables_requests[0][1]}' tce LEFT JOIN '${raw_tables_dir}/${download.tables_requests[1][1]}' koi ON tce.kepid=koi.kepid AND tce.tce_plnt_num=koi.koi_tce_plnt_num LEFT JOIN '${raw_tables_dir}/cfp.csv' cfp ON koi.kepoi_name=cfp.kepoi_name WHERE tce.tce_rogue_flag=0"
    labels_case_sql:
      - WHEN koi.koi_disposition='CONFIRMED' THEN 'PC'
      - WHEN cfp.fpwg_disp_status='CERTIFIED FP' THEN 'AFP'
      - WHEN cfp.fpwg_disp_status='CERTIFIED FA' OR kepid_koi IS NULL THEN 'NTP'
      - ELSE 'UNKNOWN'
    output: ${interim_tables_dir}/q1_q17_dr25_tce_merged.csv
    label_column: label_text
