defaults:
  - override hydra/job_logging: none
  - override hydra/hydra_logging: none

mission: kepler
raw_tables_dir: data/raw/tables
raw_time_series_dir: data/raw/time_series
interim_tables_dir: data/interim/tables
interim_time_series_dir: data/interim/time_series

download:
  verbose: true
  download_tables: true
  download_time_series: true
  script_description: |
    This script downloads star or system brightness time series and scalar stellar and TCE data and
    saves them in unaltered, raw form at user-specified locations.

    In order to download time series, a file with target identifiers is required, e.g. a file with
    TCE data.

    The script has a mechanism for retrying the download in case of an error.

    The metadata of the time series downloaded once is saved in the file and time series are not
    downloaded again the next time the script is run (unless the metadata file has been deleted).

    Note that the size of the downloaded data is significant (hundreds of GB).
  tce_file_path: ${raw_tables_dir}/q1_q17_dr25_tce.csv
  tce_file_target_id_column: kepid
  downloader:
    _target_: gaia.downloaders.KeplerDownloader
    saver:
      _target_: gaia.io.FileSaver
      tables_dir: ${raw_tables_dir}
      time_series_dir: ${raw_time_series_dir}
    cadence: llc
    mast_base_url: https://mast.stsci.edu/api/v0.1/Download/file?uri=mast:Kepler/url/missions/kepler/lightcurves
    num_async_requests: 25
  nasa_base_url: https://exoplanetarchive.ipac.caltech.edu/cgi-bin/nstedAPI/nph-nstedAPI
  tables_requests:
    - - ${download.nasa_base_url}?table=q1_q17_dr25_tce&columns=kepid,tce_plnt_num,tce_rogue_flag,tce_period,tce_time0bk,tce_time0,tce_duration,tce_depth,tce_prad,tcet_period,boot_fap,tce_cap_stat,tce_hap_stat,tce_rb_tcount0&format=csv
      - q1_q17_dr25_tce.csv
    - - ${download.nasa_base_url}?table=q1_q17_dr25_koi&columns=kepid,kepoi_name,kepler_name,koi_disposition,koi_pdisposition,koi_tce_plnt_num&format=csv
      - q1_q17_dr25_koi.csv
    - - ${download.nasa_base_url}?table=q1_q17_dr25_stellar&columns=kepid,teff,radius,mass,dens,logg,feh&format=csv
      - q1_q17_dr25_stellar.csv

preprocessing:
  tce_merge:
    script_description: Merge TCE data with other scalar data (e.g. KOI and/or CFP tables) to obtain TCE labels and Kepler names.
    select_sql: SELECT tce.*, koi.* EXCLUDE(kepid), koi.kepid AS kepid_koi # Mark TCEs whose are not present in KOI
    join_sql: "'${raw_tables_dir}/${download.tables_requests[0][1]}' tce LEFT JOIN '${raw_tables_dir}/${download.tables_requests[1][1]}' koi ON tce.kepid=koi.kepid AND tce.tce_plnt_num=koi.koi_tce_plnt_num LEFT JOIN '${raw_tables_dir}/cfp.csv' cfp ON koi.kepoi_name=cfp.kepoi_name WHERE tce.tce_rogue_flag=0"
    labels_case_sql:
      - WHEN koi.koi_disposition='CONFIRMED' THEN 'PC'
      - WHEN cfp.fpwg_disp_status='CERTIFIED FP' THEN 'AFP'
      - WHEN cfp.fpwg_disp_status='CERTIFIED FA' OR kepid_koi IS NULL THEN 'NTP'
      - ELSE 'UNKNOWN'
    output: ${interim_tables_dir}/q1_q17_dr25_tce_merged.csv
    label_column: label

  conversion:
    script_description: |
      Convert raw files to another format, optionally loading only part of the data or metadata.

      Metadata of once converted time series are saved in the file and the time series are not
      converted again the next time the script is run (unless the metadata file has been deleted).

    tce:
      converter:
        _target_: gaia.data.converters.CsvConverter
      conversion_parameters:
        inputs: ${preprocessing.tce_merge.output}
        output: ${interim_tables_dir}/q1_q17_dr25_tce.parquet
        include_columns:
          - kepid
          - tce_plnt_num
          - tce_cap_stat
          - tce_hap_stat
          - boot_fap
          - tce_rb_tcount0
          - tce_prad
          - tcet_period
          - tce_depth
          - tce_time0bk
          - tce_duration
          - tce_period
          - kepler_name
          - ${preprocessing.tce_merge.label_column}

    stellar_parameters:
      converter:
        _target_: gaia.data.converters.CsvConverter
      conversion_parameters:
        inputs: ${raw_tables_dir}/q1_q17_dr25_stellar.csv
        output: ${interim_tables_dir}/q1_q17_dr25_stellar.parquet
        include_columns:
          - kepid
          - teff
          - radius
          - mass
          - dens
          - logg
          - feh

    time_series:
      converter:
        _target_: gaia.data.converters.FitsConverter
        settings:
          data_header: LIGHTCURVE
          data_columns: [TIME, PDCSAP_FLUX, MOM_CENTR1, MOM_CENTR2]
          meta_columns: [KEPLERID, QUARTER]

          output_format: parquet
      conversion_parameters:
        inputs: ${raw_time_series_dir}/*.fits
        output_dir: ${interim_time_series_dir}
        path_target_id_pattern: (?<=kplr)\d{9}

ui:
  script_description: Launch a website with scalar data visualization (TCE, stellar parameters and statistics) as well as time series.
  assets_dir: gaia/ui/assets
  external_stylesheets:
    - https://use.fontawesome.com/releases/v6.4.0/css/all.css
    - https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap
  available_graphs:
    pdcsap_flux: pdcsap_flux
    centroid_shift: mom_centr1,mom_centr2
  server_params:
    debug: true
    host: 127.0.0.1
    port: 8050
    dev_tools_hot_reload: true
  graphs_preprocessing:
    pdcsap_flux:
      _target_: gaia.data.preprocessing.normalize_median
      _partial_: true
    mom_centr1,mom_centr2:
      _target_: gaia.utils.compose
      _args_:
        - _target_: gaia.data.preprocessing.compute_euclidean_distance
          _partial_: true
        - _target_: gaia.data.preprocessing.normalize_median
          _partial_: true

data:
  time_series_store:
    _target_: gaia.data.stores.TimeSeriesStore
    mapper:
      _target_: gaia.data.mappers.map_kepler_time_series
      _partial_: true
    reader:
      _target_: gaia.io.ParquetReader
      data_dir: ${interim_time_series_dir}

  tce_store:
    _target_: gaia.data.stores.TceStore
    mapper:
      _target_: gaia.data.mappers.map_kepler_tce
      _partial_: true
    reader:
      _target_: gaia.io.ParquetTableReader
      filepath: ${preprocessing.conversion.tce.conversion_parameters.output}
    parameters_schema:
      target_id: kepid
      tce_id: tce_plnt_num
      name: kepler_name
      label: label
      duration: tce_duration
      epoch: tce_time0bk
      period: tce_period

  stellar_store:
    _target_: gaia.data.stores.StellarParametersStore
    mapper:
      _target_: gaia.data.mappers.map_kepler_stallar_parameters
      _partial_: true
    reader:
      _target_: gaia.io.ParquetTableReader
      filepath: ${interim_tables_dir}/q1_q17_dr25_stellar2.parquet
    parameters_schema:
      id: kepid
